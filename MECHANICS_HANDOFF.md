# Delve — Mechanics Handoff

Этот документ нужен для продолжения разработки в другой нейросети/команде без потери контекста.

## 1) Текущее состояние проекта

Проект: браузерная игра про шахтера (основа — сапер) с мета-экономикой:
- Основная игра (сапер-рейды)
- Магазин (конвертация руды в золото)
- Клуб старателей (расходники/пассивки)
- Гильдия шахтеров (пассивная добыча)
- TD эндгейм (тратит золото, дает билеты)
- Гача (тратит билеты, выдает кирки)
- Инвентарь кирок (экипировка)

## 2) Что сделано в последнем апдейте

### 2.1 Новый sink золота в основной игре: глубина шахты

Добавлена система глубины (main menu):
- Ключ: `delve_mine_depth_v1`
- Диапазон уровней: 1..30
- Покупка за золото, цена растет экспоненциально

Формулы:
- Стоимость уровня: `140 * 1.3^(level-1)`
- Бонус к руде: до +120%
- Рост риска обвалов: до +14% к `unstableChance`
- Штраф AFK-обвала: до -25с к `idleCollapseSec`

Глубина влияет на каждый новый забег через `createGameState(diffKey, diffOverrides)`.

### 2.2 TD баланс против бесконечного спама

В TD добавлены динамические расходы:
- Плата за старт волны: растет по номеру волны
- Рост стоимости постройки башен в зависимости от:
  - текущей волны
  - количества уже построенных башен
- Рост стоимости апгрейда башни по волне и уровню башни

Отображение в UI:
- Цена входа в следующую волну
- Актуальные цены всех трех башен
- Цена выбранной башни обновляется в реальном времени

## 3) Важные файлы

### Core gameplay
- `src/game.js`
  - `createGameState(diffKey, diffOverrides)`
  - базовые сложности и генерация поля

- `src/main.js`
  - главное меню и запуск рейдов
  - система глубины
  - мета-прогресс и роутинг по экранам

### TD
- `src/endgame-td.js`
  - волны, башни, цены, апгрейды между волнами

### Gacha/Inventory
- `src/pickaxe-gacha.js`
  - билеты, pity, крутка, инвентарь кирок

### Стили
- `src/style.css`
  - UI/мобилка/панели TD/гача/главного меню

## 4) localStorage ключи (основные)

Прогресс:
- `delve_upg_*`
- `delve_shop_open`
- `delve_td_open`
- `delve_td_tickets`
- `delve_gacha_pity_v1`
- `delve_pickaxe_inventory_v1`
- `delve_pickaxe_equipped_v1`
- `delve_miners_guild_open`
- `delve_miners_guild_state_v2`
- `delve_prospectors_state_v1` (если есть в модуле)

Экономика:
- `delve_gold`
- `delve_bank_copper`
- `delve_bank_silver`
- `delve_bank_gold`
- `delve_bank_diamond`
- `delve_mine_depth_v1`

Системные:
- `delve_backup_v1`
- `delve_last_reset_at`
- `delve_escape_streak_v1`

## 5) Почему все еще может быть дисбаланс

1. Доход золота может слишком быстро обгонять расходы TD/глубины на поздней стадии.
2. Билеты с TD могут терять ценность после получения сильных кирок.
3. Глубина дает сильный рост добычи; при неверных коэффициентах может ломать экономику.

## 6) Что перерабатывать дальше (приоритет)

### P1: Единая экономическая модель
Сделать целевые кривые (таблицей):
- Gold/min на этапах ранняя/средняя/поздняя игра
- Средняя цена одного meaningful решения в TD
- Сколько рейдов нужно на 1 upgrade глубины

### P1: Перепривязать TD к прогрессу шахты
Вариант:
- Вход в TD зависит от «энергии каравана/гарнизона», которая пополняется рейдами сапера
- Или волны в TD требуют ресурс из шахты (не только золото), чтобы держать связку режимов

### P1: Билеты и гача как долгий горизонт
- Добавить sink дубликатов кирок (переплавка/улучшение)
- Добавить лимиты/стоимость ре-ролла баффов кирки
- Добавить серию сезонных модификаторов на TD за билеты

### P2: Глубина как осмысленный риск, а не просто множитель
- На высоких глубинах добавить новые типы угроз/клеток
- Ввести «слои» (Tier I/II/III) с разными паттернами поля
- Награда должна масштабироваться не только количеством руды, но и качеством прохождения

### P2: Телеметрия/метрики баланса
Минимум логировать в localStorage или dev-консоль:
- время до first gold sink
- gold spent/hour по системам (depth, TD, guild, etc.)
- tickets earned/spent ratio
- средний уровень волны TD перед поражением

## 7) Быстрые команды для следующего разработчика

```bash
npm install
npm run dev
npm run build
```

## 8) Рекомендованный порядок рефакторинга

1. Вынести формулы экономики в отдельный модуль (например `src/economy-balance.js`)
2. Покрыть формулы unit-тестами (хотя бы smoke)
3. После стабилизации формул трогать UI
4. Затем расширять контент (новые клетки/враги/кироки)

## 9) Кратко по UX задачам, которые уже просили

- TD и гача должны быть в верхнем меню
- Мобильная верстка должна отдавать приоритет полю игры
- Логи/сообщения не должны перекрывать важный UI
- Инвентарь показывает только полученные кирки
- В гаче не должно быть кнопок экипировки (экипировка через инвентарь)

